"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var application = require("application");
var applicationSettings = require("application-settings");
var observable_array_1 = require("data/observable-array");
var observable_1 = require("data/observable");
var Argon = require("@argonjs/argon");
var BookmarkItem = (function (_super) {
    __extends(BookmarkItem, _super);
    function BookmarkItem(item) {
        var _this = _super.call(this, item) || this;
        _this.builtin = false;
        var uri = item.uri;
        // reuse an existing BookmarkItem if one exists
        if (historyMap.has(uri))
            return historyMap.get(uri);
        if (realityMap.has(uri))
            return realityMap.get(uri);
        if (favoriteMap.has(uri))
            return favoriteMap.get(uri);
        return _this;
    }
    BookmarkItem.prototype.toJSON = function () {
        return {
            title: this.title,
            uri: this.uri
        };
    };
    return BookmarkItem;
}(observable_1.Observable));
exports.BookmarkItem = BookmarkItem;
var favoriteList = new observable_array_1.ObservableArray();
exports.favoriteList = favoriteList;
var historyList = new observable_array_1.ObservableArray();
exports.historyList = historyList;
var realityList = new observable_array_1.ObservableArray();
exports.realityList = realityList;
var FilterControl = (function (_super) {
    __extends(FilterControl, _super);
    function FilterControl() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.showFilteredResults = false;
        return _this;
    }
    return FilterControl;
}(observable_1.Observable));
var filterControl = new FilterControl();
exports.filterControl = filterControl;
var filteredFavoriteList = new observable_array_1.ObservableArray();
exports.filteredFavoriteList = filteredFavoriteList;
var filteredHistoryList = new observable_array_1.ObservableArray();
exports.filteredHistoryList = filteredHistoryList;
var favoriteMap = new Map();
exports.favoriteMap = favoriteMap;
var historyMap = new Map();
exports.historyMap = historyMap;
var realityMap = new Map();
exports.realityMap = realityMap;
function updateMap(data, map) {
    var list = data.object;
    for (var i = 0; i < data.addedCount; i++) {
        var item = list.getItem(data.index + i);
        map.set(item.uri, item);
    }
    data.removed && data.removed.forEach(function (item) {
        map.delete(item.uri);
    });
}
favoriteList.on('change', function (data) { return updateMap(data, favoriteMap); });
historyList.on('change', function (data) { return updateMap(data, historyMap); });
realityList.on('change', function (data) { return updateMap(data, realityMap); });
var builtinFavorites = [
    new BookmarkItem({
        title: 'Aplicación de Realidad Aumentada Online',
        uri: 'http://200.126.23.63:1337/userinterface/index.html'
    }),
    new BookmarkItem({
        title: 'Aplicación de Realidad Aumentada Local',
        uri: '~/components/userinterface/index.html'
    }),
    new BookmarkItem({
        title: 'Ejemplo de Vuforia',
        uri: 'http://200.126.23.63:1337/vuforia/index.html'
    }),
    new BookmarkItem({
        title: 'Ejemplo de Vuforia Online',
        uri: 'https://samples.argonjs.io/vuforia/index.html'
    })
];
builtinFavorites.forEach(function (item) {
    item.builtin = true;
    favoriteList.push(item);
});
var builtinRealities = [
    new BookmarkItem({ uri: Argon.RealityViewer.LIVE, title: 'Live' })
];
builtinRealities.forEach(function (item) {
    item.builtin = true;
    realityList.push(item);
});
var FAVORITE_LIST_KEY = 'favorite_list';
var HISTORY_LIST_KEY = 'history_list';
if (applicationSettings.hasKey(FAVORITE_LIST_KEY)) {
    // console.log(applicationSettings.getString(FAVORITE_LIST_KEY))
    var savedFavorites = JSON.parse(applicationSettings.getString(FAVORITE_LIST_KEY));
    savedFavorites.forEach(function (item) {
        if (!favoriteMap.has(item.uri))
            favoriteList.push(new BookmarkItem(item));
    });
}
if (applicationSettings.hasKey(HISTORY_LIST_KEY)) {
    // console.log(applicationSettings.getString(HISTORY_LIST_KEY))
    var savedHistory = JSON.parse(applicationSettings.getString(HISTORY_LIST_KEY));
    savedHistory.forEach(function (item) {
        historyList.push(new BookmarkItem(item));
    });
}
function saveFavorites() {
    var userFavorites = favoriteList.filter(function (item) { return !item.builtin; });
    applicationSettings.setString(FAVORITE_LIST_KEY, JSON.stringify(userFavorites));
}
function saveHistory() {
    var history = historyList.map(function (item) { return item; }); // convert to standard array
    applicationSettings.setString(HISTORY_LIST_KEY, JSON.stringify(history));
}
function saveBookmarks() {
    saveFavorites();
    saveHistory();
}
application.on(application.suspendEvent, saveBookmarks);
favoriteList.on('change', saveFavorites);
historyList.on('change', saveHistory);
function pushToHistory(url, title) {
    var historyBookmarkItem = historyMap.get(url);
    if (historyBookmarkItem) {
        var i = historyList.indexOf(historyBookmarkItem);
        historyList.splice(i, 1);
        historyList.unshift(historyBookmarkItem);
    }
    else {
        historyList.unshift(new BookmarkItem({
            uri: url,
            title: title
        }));
    }
}
exports.pushToHistory = pushToHistory;
function updateTitle(url, title) {
    var historyBookmarkItem = historyMap.get(url);
    if (historyBookmarkItem && !historyBookmarkItem.builtin) {
        historyBookmarkItem.set('title', title);
    }
}
exports.updateTitle = updateTitle;
function filterBookmarks(text) {
    var regex = new RegExp(text, "i");
    clearFilter();
    favoriteList.forEach(function (bookmark) {
        if (regex.test(bookmark.uri) || (bookmark.title && regex.test(bookmark.title))) {
            filteredFavoriteList.push(bookmark);
        }
    });
    historyList.forEach(function (bookmark) {
        if (regex.test(bookmark.uri) || (bookmark.title && regex.test(bookmark.title))) {
            filteredHistoryList.push(bookmark);
        }
    });
}
exports.filterBookmarks = filterBookmarks;
function clearFilter() {
    while (filteredFavoriteList.length > 0) {
        filteredFavoriteList.pop();
    }
    while (filteredHistoryList.length > 0) {
        filteredHistoryList.pop();
    }
}
exports.clearFilter = clearFilter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9va21hcmtzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYm9va21hcmtzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEseUNBQTRDO0FBQzVDLDBEQUE2RDtBQUM3RCwwREFBbUU7QUFDbkUsOENBQTJDO0FBRTNDLHNDQUF1QztBQUV2QztJQUEyQixnQ0FBVTtJQUtqQyxzQkFBWSxJQUdYO1FBSEQsWUFJSSxrQkFBTSxJQUFJLENBQUMsU0FPZDtRQWJELGFBQU8sR0FBRyxLQUFLLENBQUM7UUFPWixJQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDO1FBQ3JCLCtDQUErQztRQUMvQyxFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFFLENBQUM7UUFDckQsRUFBRSxDQUFDLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBRSxDQUFDO1FBQ3JELEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7WUFBQyxNQUFNLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUUsQ0FBQztRQUN2RCxNQUFNLENBQUMsS0FBSSxDQUFDO0lBQ2hCLENBQUM7SUFFRCw2QkFBTSxHQUFOO1FBQ0ksTUFBTSxDQUFDO1lBQ0gsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLO1lBQ2pCLEdBQUcsRUFBRSxJQUFJLENBQUMsR0FBRztTQUNoQixDQUFBO0lBQ0wsQ0FBQztJQUNMLG1CQUFDO0FBQUQsQ0FBQyxBQXhCRCxDQUEyQix1QkFBVSxHQXdCcEM7QUEwR0csb0NBQVk7QUF4R2hCLElBQU0sWUFBWSxHQUFHLElBQUksa0NBQWUsRUFBZ0IsQ0FBQztBQXlHckQsb0NBQVk7QUF4R2hC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QUN6QixFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDN0UsbUJBQW1CLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3ZDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFiRCwwQ0FhQztBQUVEO0lBQ0ksT0FBTyxvQkFBb0IsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7UUFDckMsb0JBQW9CLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDL0IsQ0FBQztJQUNELE9BQU8sbUJBQW1CLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQ3BDLG1CQUFtQixDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQzlCLENBQUM7QUFDTCxDQUFDO0FBUEQsa0NBT0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXBwbGljYXRpb24gPSByZXF1aXJlKCdhcHBsaWNhdGlvbicpO1xyXG5pbXBvcnQgYXBwbGljYXRpb25TZXR0aW5ncyA9IHJlcXVpcmUoJ2FwcGxpY2F0aW9uLXNldHRpbmdzJyk7XHJcbmltcG9ydCB7T2JzZXJ2YWJsZUFycmF5LCBDaGFuZ2VkRGF0YX0gZnJvbSAnZGF0YS9vYnNlcnZhYmxlLWFycmF5JztcclxuaW1wb3J0IHtPYnNlcnZhYmxlfSBmcm9tICdkYXRhL29ic2VydmFibGUnO1xyXG5cclxuaW1wb3J0ICogYXMgQXJnb24gZnJvbSAnQGFyZ29uanMvYXJnb24nXHJcblxyXG5jbGFzcyBCb29rbWFya0l0ZW0gZXh0ZW5kcyBPYnNlcnZhYmxlIHtcclxuICAgIHRpdGxlPzpzdHJpbmc7XHJcbiAgICB1cmk6c3RyaW5nO1xyXG4gICAgYnVpbHRpbiA9IGZhbHNlO1xyXG4gICAgXHJcbiAgICBjb25zdHJ1Y3RvcihpdGVtOntcclxuICAgICAgICB0aXRsZT86c3RyaW5nLFxyXG4gICAgICAgIHVyaTpzdHJpbmdcclxuICAgIH0pIHtcclxuICAgICAgICBzdXBlcihpdGVtKTtcclxuICAgICAgICBjb25zdCB1cmkgPSBpdGVtLnVyaTtcclxuICAgICAgICAvLyByZXVzZSBhbiBleGlzdGluZyBCb29rbWFya0l0ZW0gaWYgb25lIGV4aXN0c1xyXG4gICAgICAgIGlmIChoaXN0b3J5TWFwLmhhcyh1cmkpKSByZXR1cm4gaGlzdG9yeU1hcC5nZXQodXJpKSE7IFxyXG4gICAgICAgIGlmIChyZWFsaXR5TWFwLmhhcyh1cmkpKSByZXR1cm4gcmVhbGl0eU1hcC5nZXQodXJpKSE7IFxyXG4gICAgICAgIGlmIChmYXZvcml0ZU1hcC5oYXModXJpKSkgcmV0dXJuIGZhdm9yaXRlTWFwLmdldCh1cmkpITsgXHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHRvSlNPTigpIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICB0aXRsZTogdGhpcy50aXRsZSxcclxuICAgICAgICAgICAgdXJpOiB0aGlzLnVyaVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuY29uc3QgZmF2b3JpdGVMaXN0ID0gbmV3IE9ic2VydmFibGVBcnJheTxCb29rbWFya0l0ZW0+KCk7XHJcbmNvbnN0IGhpc3RvcnlMaXN0ID0gbmV3IE9ic2VydmFibGVBcnJheTxCb29rbWFya0l0ZW0+KCk7XHJcbmNvbnN0IHJlYWxpdHlMaXN0ID0gbmV3IE9ic2VydmFibGVBcnJheTxCb29rbWFya0l0ZW0+KCk7XHJcblxyXG5jbGFzcyBGaWx0ZXJDb250cm9sIGV4dGVuZHMgT2JzZXJ2YWJsZSB7XHJcbiAgICBzaG93RmlsdGVyZWRSZXN1bHRzID0gZmFsc2U7XHJcbn1cclxuXHJcbnZhciBmaWx0ZXJDb250cm9sID0gbmV3IEZpbHRlckNvbnRyb2woKTtcclxudmFyIGZpbHRlcmVkRmF2b3JpdGVMaXN0ID0gbmV3IE9ic2VydmFibGVBcnJheTxCb29rbWFya0l0ZW0+KCk7XHJcbnZhciBmaWx0ZXJlZEhpc3RvcnlMaXN0ID0gbmV3IE9ic2VydmFibGVBcnJheTxCb29rbWFya0l0ZW0+KCk7XHJcblxyXG5jb25zdCBmYXZvcml0ZU1hcCA9IG5ldyBNYXA8c3RyaW5nLCBCb29rbWFya0l0ZW0+KCk7XHJcbmNvbnN0IGhpc3RvcnlNYXAgPSBuZXcgTWFwPHN0cmluZywgQm9va21hcmtJdGVtPigpO1xyXG5jb25zdCByZWFsaXR5TWFwID0gbmV3IE1hcDxzdHJpbmcsIEJvb2ttYXJrSXRlbT4oKTtcclxuXHJcbmZ1bmN0aW9uIHVwZGF0ZU1hcChkYXRhOkNoYW5nZWREYXRhPEJvb2ttYXJrSXRlbT4sIG1hcDpNYXA8c3RyaW5nLCBCb29rbWFya0l0ZW0+KSB7XHJcbiAgICBjb25zdCBsaXN0ID0gPE9ic2VydmFibGVBcnJheTxCb29rbWFya0l0ZW0+PmRhdGEub2JqZWN0XHJcbiAgICBmb3IgKGxldCBpPTA7IGkgPCBkYXRhLmFkZGVkQ291bnQ7IGkrKykge1xyXG4gICAgICAgIHZhciBpdGVtID0gbGlzdC5nZXRJdGVtKGRhdGEuaW5kZXggKyBpKTtcclxuICAgICAgICBtYXAuc2V0KGl0ZW0udXJpLCBpdGVtKTtcclxuICAgIH1cclxuICAgIGRhdGEucmVtb3ZlZCAmJiBkYXRhLnJlbW92ZWQuZm9yRWFjaCgoaXRlbSk9PntcclxuICAgICAgICBtYXAuZGVsZXRlKGl0ZW0udXJpKTtcclxuICAgIH0pXHJcbn1cclxuXHJcbmZhdm9yaXRlTGlzdC5vbignY2hhbmdlJywgKGRhdGEpID0+IHVwZGF0ZU1hcChkYXRhLCBmYXZvcml0ZU1hcCkpO1xyXG5oaXN0b3J5TGlzdC5vbignY2hhbmdlJywgKGRhdGEpID0+IHVwZGF0ZU1hcChkYXRhLCBoaXN0b3J5TWFwKSk7XHJcbnJlYWxpdHlMaXN0Lm9uKCdjaGFuZ2UnLCAoZGF0YSkgPT4gdXBkYXRlTWFwKGRhdGEsIHJlYWxpdHlNYXApKTtcclxuXHJcbmNvbnN0IGJ1aWx0aW5GYXZvcml0ZXM6QXJyYXk8Qm9va21hcmtJdGVtPiA9IFtcclxuICAgIG5ldyBCb29rbWFya0l0ZW0oe1xyXG4gICAgICAgIHRpdGxlOiAnQXBsaWNhY2nDs24gZGUgUmVhbGlkYWQgQXVtZW50YWRhIE9ubGluZScsXHJcbiAgICAgICAgdXJpOiAnaHR0cDovLzIwMC4xMjYuMjMuNjM6MTMzNy91c2VyaW50ZXJmYWNlL2luZGV4Lmh0bWwnXHJcbiAgICB9KSxcclxuICAgIG5ldyBCb29rbWFya0l0ZW0oe1xyXG4gICAgICAgIHRpdGxlOiAnQXBsaWNhY2nDs24gZGUgUmVhbGlkYWQgQXVtZW50YWRhIExvY2FsJyxcclxuICAgICAgICB1cmk6ICd+L2NvbXBvbmVudHMvdXNlcmludGVyZmFjZS9pbmRleC5odG1sJ1xyXG4gICAgfSksXHJcbiAgICBuZXcgQm9va21hcmtJdGVtKHtcclxuICAgICAgICB0aXRsZTogJ0VqZW1wbG8gZGUgVnVmb3JpYScsXHJcbiAgICAgICAgdXJpOiAnaHR0cDovLzIwMC4xMjYuMjMuNjM6MTMzNy92dWZvcmlhL2luZGV4Lmh0bWwnXHJcbiAgICB9KSxcclxuICAgIG5ldyBCb29rbWFya0l0ZW0oe1xyXG4gICAgICAgIHRpdGxlOiAnRWplbXBsbyBkZSBWdWZvcmlhIE9ubGluZScsXHJcbiAgICAgICAgdXJpOiAnaHR0cHM6Ly9zYW1wbGVzLmFyZ29uanMuaW8vdnVmb3JpYS9pbmRleC5odG1sJ1xyXG4gICAgfSlcclxuXVxyXG5cclxuYnVpbHRpbkZhdm9yaXRlcy5mb3JFYWNoKChpdGVtKT0+IHsgXHJcbiAgICBpdGVtLmJ1aWx0aW4gPSB0cnVlO1xyXG4gICAgZmF2b3JpdGVMaXN0LnB1c2goaXRlbSk7XHJcbn0pO1xyXG5cclxuY29uc3QgYnVpbHRpblJlYWxpdGllczpBcnJheTxCb29rbWFya0l0ZW0+ID0gW1xyXG4gICAgbmV3IEJvb2ttYXJrSXRlbSh7dXJpOkFyZ29uLlJlYWxpdHlWaWV3ZXIuTElWRSwgdGl0bGU6J0xpdmUnfSlcclxuXVxyXG5cclxuYnVpbHRpblJlYWxpdGllcy5mb3JFYWNoKChpdGVtKT0+IHsgXHJcbiAgICBpdGVtLmJ1aWx0aW4gPSB0cnVlO1xyXG4gICAgcmVhbGl0eUxpc3QucHVzaChpdGVtKTtcclxufSk7XHJcblxyXG5jb25zdCBGQVZPUklURV9MSVNUX0tFWSA9ICdmYXZvcml0ZV9saXN0JztcclxuY29uc3QgSElTVE9SWV9MSVNUX0tFWSA9ICdoaXN0b3J5X2xpc3QnO1xyXG5cclxuaWYgKGFwcGxpY2F0aW9uU2V0dGluZ3MuaGFzS2V5KEZBVk9SSVRFX0xJU1RfS0VZKSkge1xyXG4gICAgLy8gY29uc29sZS5sb2coYXBwbGljYXRpb25TZXR0aW5ncy5nZXRTdHJpbmcoRkFWT1JJVEVfTElTVF9LRVkpKVxyXG4gICAgY29uc3Qgc2F2ZWRGYXZvcml0ZXM6QXJyYXk8Qm9va21hcmtJdGVtPiA9IEpTT04ucGFyc2UoYXBwbGljYXRpb25TZXR0aW5ncy5nZXRTdHJpbmcoRkFWT1JJVEVfTElTVF9LRVkpKTtcclxuICAgIHNhdmVkRmF2b3JpdGVzLmZvckVhY2goKGl0ZW0pPT57XHJcbiAgICAgICAgaWYgKCFmYXZvcml0ZU1hcC5oYXMoaXRlbS51cmkpKVxyXG4gICAgICAgICAgICBmYXZvcml0ZUxpc3QucHVzaChuZXcgQm9va21hcmtJdGVtKGl0ZW0pKTtcclxuICAgIH0pO1xyXG59XHJcblxyXG5pZiAoYXBwbGljYXRpb25TZXR0aW5ncy5oYXNLZXkoSElTVE9SWV9MSVNUX0tFWSkpIHtcclxuICAgIC8vIGNvbnNvbGUubG9nKGFwcGxpY2F0aW9uU2V0dGluZ3MuZ2V0U3RyaW5nKEhJU1RPUllfTElTVF9LRVkpKVxyXG4gICAgY29uc3Qgc2F2ZWRIaXN0b3J5OkFycmF5PEJvb2ttYXJrSXRlbT4gPSBKU09OLnBhcnNlKGFwcGxpY2F0aW9uU2V0dGluZ3MuZ2V0U3RyaW5nKEhJU1RPUllfTElTVF9LRVkpKTtcclxuICAgIHNhdmVkSGlzdG9yeS5mb3JFYWNoKChpdGVtKT0+e1xyXG4gICAgICAgIGhpc3RvcnlMaXN0LnB1c2gobmV3IEJvb2ttYXJrSXRlbShpdGVtKSk7XHJcbiAgICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gc2F2ZUZhdm9yaXRlcygpIHtcclxuICAgIGNvbnN0IHVzZXJGYXZvcml0ZXMgPSBmYXZvcml0ZUxpc3QuZmlsdGVyKChpdGVtKT0+IWl0ZW0uYnVpbHRpbik7XHJcbiAgICBhcHBsaWNhdGlvblNldHRpbmdzLnNldFN0cmluZyhGQVZPUklURV9MSVNUX0tFWSwgSlNPTi5zdHJpbmdpZnkodXNlckZhdm9yaXRlcykpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzYXZlSGlzdG9yeSgpIHtcclxuICAgIGNvbnN0IGhpc3RvcnkgPSBoaXN0b3J5TGlzdC5tYXAoKGl0ZW0pPT5pdGVtKTsgLy8gY29udmVydCB0byBzdGFuZGFyZCBhcnJheVxyXG4gICAgYXBwbGljYXRpb25TZXR0aW5ncy5zZXRTdHJpbmcoSElTVE9SWV9MSVNUX0tFWSwgSlNPTi5zdHJpbmdpZnkoaGlzdG9yeSkpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzYXZlQm9va21hcmtzKCkge1xyXG4gICAgc2F2ZUZhdm9yaXRlcygpO1xyXG4gICAgc2F2ZUhpc3RvcnkoKTtcclxufVxyXG5cclxuYXBwbGljYXRpb24ub24oYXBwbGljYXRpb24uc3VzcGVuZEV2ZW50LHNhdmVCb29rbWFya3MpO1xyXG5mYXZvcml0ZUxpc3Qub24oJ2NoYW5nZScsIHNhdmVGYXZvcml0ZXMpO1xyXG5oaXN0b3J5TGlzdC5vbignY2hhbmdlJywgc2F2ZUhpc3RvcnkpO1xyXG5cclxuZXhwb3J0IHtcclxuICAgIEJvb2ttYXJrSXRlbSxcclxuICAgIGZhdm9yaXRlTGlzdCxcclxuICAgIGhpc3RvcnlMaXN0LFxyXG4gICAgcmVhbGl0eUxpc3QsXHJcbiAgICBmYXZvcml0ZU1hcCxcclxuICAgIGhpc3RvcnlNYXAsXHJcbiAgICByZWFsaXR5TWFwLFxyXG4gICAgZmlsdGVyQ29udHJvbCxcclxuICAgIGZpbHRlcmVkRmF2b3JpdGVMaXN0LFxyXG4gICAgZmlsdGVyZWRIaXN0b3J5TGlzdFxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcHVzaFRvSGlzdG9yeSh1cmw6c3RyaW5nLCB0aXRsZT86c3RyaW5nKSB7XHJcbiAgICBjb25zdCBoaXN0b3J5Qm9va21hcmtJdGVtID0gaGlzdG9yeU1hcC5nZXQodXJsKTtcclxuICAgIGlmIChoaXN0b3J5Qm9va21hcmtJdGVtKSB7XHJcbiAgICAgICAgbGV0IGkgPSBoaXN0b3J5TGlzdC5pbmRleE9mKGhpc3RvcnlCb29rbWFya0l0ZW0pO1xyXG4gICAgICAgIGhpc3RvcnlMaXN0LnNwbGljZShpLCAxKTtcclxuICAgICAgICBoaXN0b3J5TGlzdC51bnNoaWZ0KGhpc3RvcnlCb29rbWFya0l0ZW0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBoaXN0b3J5TGlzdC51bnNoaWZ0KG5ldyBCb29rbWFya0l0ZW0oe1xyXG4gICAgICAgICAgICB1cmk6IHVybCxcclxuICAgICAgICAgICAgdGl0bGU6IHRpdGxlXHJcbiAgICAgICAgfSkpXHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGVUaXRsZSh1cmw6c3RyaW5nLCB0aXRsZTpzdHJpbmcpIHtcclxuICAgIHZhciBoaXN0b3J5Qm9va21hcmtJdGVtID0gaGlzdG9yeU1hcC5nZXQodXJsKTtcclxuICAgIGlmIChoaXN0b3J5Qm9va21hcmtJdGVtICYmICFoaXN0b3J5Qm9va21hcmtJdGVtLmJ1aWx0aW4pIHtcclxuICAgICAgICBoaXN0b3J5Qm9va21hcmtJdGVtLnNldCgndGl0bGUnLCB0aXRsZSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBmaWx0ZXJCb29rbWFya3ModGV4dDpzdHJpbmcpIHtcclxuICAgIGNvbnN0IHJlZ2V4ID0gbmV3IFJlZ0V4cCh0ZXh0LCBcImlcIik7XHJcbiAgICBjbGVhckZpbHRlcigpO1xyXG4gICAgZmF2b3JpdGVMaXN0LmZvckVhY2goKGJvb2ttYXJrKT0+IHtcclxuICAgICAgICBpZiAocmVnZXgudGVzdChib29rbWFyay51cmkpIHx8IChib29rbWFyay50aXRsZSAmJiByZWdleC50ZXN0KGJvb2ttYXJrLnRpdGxlKSkpIHtcclxuICAgICAgICAgICAgZmlsdGVyZWRGYXZvcml0ZUxpc3QucHVzaChib29rbWFyayk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICBoaXN0b3J5TGlzdC5mb3JFYWNoKChib29rbWFyayk9PiB7XHJcbiAgICAgICAgaWYgKHJlZ2V4LnRlc3QoYm9va21hcmsudXJpKSB8fCAoYm9va21hcmsudGl0bGUgJiYgcmVnZXgudGVzdChib29rbWFyay50aXRsZSkpKSB7XHJcbiAgICAgICAgICAgIGZpbHRlcmVkSGlzdG9yeUxpc3QucHVzaChib29rbWFyayk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjbGVhckZpbHRlcigpIHtcclxuICAgIHdoaWxlIChmaWx0ZXJlZEZhdm9yaXRlTGlzdC5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgZmlsdGVyZWRGYXZvcml0ZUxpc3QucG9wKCk7XHJcbiAgICB9XHJcbiAgICB3aGlsZSAoZmlsdGVyZWRIaXN0b3J5TGlzdC5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgZmlsdGVyZWRIaXN0b3J5TGlzdC5wb3AoKTtcclxuICAgIH1cclxufSJdfQ==